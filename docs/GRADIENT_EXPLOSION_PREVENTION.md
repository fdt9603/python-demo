# æ¢¯åº¦çˆ†ç‚¸é˜²æŠ¤æªæ–½è¯¦è§£

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜è®­ç»ƒä»£ç ä¸­æ‰€æœ‰é˜²æ­¢æ¢¯åº¦çˆ†ç‚¸çš„å…³é”®ä¿®æ”¹ç‚¹ã€‚

## ğŸ”´ æ ¸å¿ƒé—®é¢˜å›é¡¾

ä¹‹å‰çš„æ¢¯åº¦çˆ†ç‚¸ä¸»è¦ç”±ä»¥ä¸‹åŸå› å¯¼è‡´ï¼š
1. **é”™è¯¯çš„æ ‡ç­¾æ©ç **ï¼šåªè®¡ç®—äº† assistant éƒ¨åˆ†çš„ lossï¼Œä½†æ©ç é€»è¾‘é”™è¯¯
2. **é”™è¯¯çš„æ¨¡å‹ç±»**ï¼šä½¿ç”¨äº† `AutoModelForVision2Seq` è€Œé `Qwen3VLForConditionalGeneration`
3. **å­¦ä¹ ç‡è¿‡é«˜**ï¼š`5e-4` å¯¹äº 32B æ¨¡å‹è¿‡å¤§
4. **ç¼ºå°‘æ¢¯åº¦è£å‰ª**ï¼šæ²¡æœ‰ `max_grad_norm`
5. **ç¼ºå°‘æ¢¯åº¦æ£€æŸ¥ç‚¹**ï¼šæ²¡æœ‰å¯ç”¨ `gradient_checkpointing`

---

## âœ… å·²ä¿®å¤çš„å…³é”®ä½ç½®

### 1. æ•°æ®æ•´ç†å™¨ - æ­£ç¡®çš„æ ‡ç­¾æ©ç ï¼ˆç¬¬32-86è¡Œï¼‰

**ä½ç½®**ï¼š`src/train/pcb_train.py` çš„ `PCBDataCollator` ç±»

**å…³é”®ä¿®æ”¹**ï¼š
```python
# âœ… ä½¿ç”¨å®˜æ–¹ apply_chat_template æ„é€ è¾“å…¥
texts = [
    self.processor.apply_chat_template(
        m, tokenize=False, add_generation_prompt=False
    )
    for m in messages
]

# âœ… æ­£ç¡®è¯†åˆ« assistant token å¹¶æ©ç å‰é¢çš„å†…å®¹
assistant_token_id = self.processor.tokenizer.convert_tokens_to_ids("<|assistant|>")
for i, label in enumerate(labels):
    assistant_starts = (inputs["input_ids"][i] == assistant_token_id).nonzero()
    if len(assistant_starts) > 0:
        start_pos = assistant_starts[0].item()
        labels[i, :start_pos] = -100  # åªè®¡ç®— assistant éƒ¨åˆ†çš„ loss
```

**ä½œç”¨**ï¼š
- âœ… ç¡®ä¿åªå¯¹ assistant çš„å›ç­”éƒ¨åˆ†è®¡ç®—æ¢¯åº¦
- âœ… é¿å…å¯¹é—®é¢˜/å›¾åƒéƒ¨åˆ†è®¡ç®—æ¢¯åº¦ï¼ˆè¿™äº›éƒ¨åˆ†ä¸éœ€è¦å­¦ä¹ ï¼‰
- âœ… ä½¿ç”¨å®˜æ–¹ `apply_chat_template` ç¡®ä¿æ ¼å¼æ­£ç¡®

---

### 2. æ¨¡å‹ç±» - ä½¿ç”¨æ­£ç¡®çš„ Qwen3VL ç±»ï¼ˆç¬¬10è¡Œã€ç¬¬163è¡Œï¼‰

**ä½ç½®**ï¼š
- å¯¼å…¥ï¼šç¬¬10è¡Œ
- ä½¿ç”¨ï¼šç¬¬163è¡Œ

**å…³é”®ä¿®æ”¹**ï¼š
```python
# âœ… å¯¼å…¥æ­£ç¡®çš„æ¨¡å‹ç±»
from transformers import Qwen3VLForConditionalGeneration

# âœ… ä½¿ç”¨æ­£ç¡®çš„æ¨¡å‹ç±»åŠ è½½
model = Qwen3VLForConditionalGeneration.from_pretrained(model_name, **model_kwargs)
```

**ä½œç”¨**ï¼š
- âœ… `Qwen3VLForConditionalGeneration` æ˜¯ Qwen3-VL çš„ä¸“ç”¨ç±»ï¼Œæ¶æ„åŒ¹é…
- âœ… `AutoModelForVision2Seq` æ˜¯é€šç”¨ç±»ï¼Œå¯èƒ½å¯¼è‡´æ¶æ„ä¸åŒ¹é…å’Œæ¢¯åº¦è®¡ç®—é”™è¯¯

---

### 3. è§†è§‰å¡”å†»ç»“ - é˜²æ­¢ç ´åé¢„è®­ç»ƒç‰¹å¾ï¼ˆç¬¬210-213è¡Œï¼‰

**ä½ç½®**ï¼š`src/train/pcb_train.py` çš„ `setup_lora` å‡½æ•°

**å…³é”®ä¿®æ”¹**ï¼š
```python
# âœ… åœ¨ LoRA åº”ç”¨åå†»ç»“è§†è§‰å¡”
for name, param in model.named_parameters():
    if "vision" in name or "visual" in name:
        param.requires_grad = False
```

**ä½œç”¨**ï¼š
- âœ… è§†è§‰å¡”æ˜¯é¢„è®­ç»ƒçš„ï¼Œä¸åº”è¯¥åœ¨å¾®è°ƒæ—¶æ›´æ–°
- âœ… åªè®­ç»ƒè¯­è¨€æ¨¡å‹éƒ¨åˆ†ï¼ˆé€šè¿‡ LoRAï¼‰
- âœ… é¿å…è§†è§‰ç‰¹å¾è¢«ç ´åå¯¼è‡´æ¢¯åº¦å¼‚å¸¸

---

### 4. è®­ç»ƒå‚æ•° - æ¢¯åº¦è£å‰ªå’Œç¨³å®šè®¾ç½®ï¼ˆç¬¬363-383è¡Œï¼‰

**ä½ç½®**ï¼š`src/train/pcb_train.py` çš„ `TrainingArguments`

**å…³é”®ä¿®æ”¹**ï¼š
```python
training_args = TrainingArguments(
    # âœ… æ¢¯åº¦è£å‰ªï¼šé˜²æ­¢æ¢¯åº¦çˆ†ç‚¸
    max_grad_norm=0.3,  # æ›´ä¸¥æ ¼çš„æ¢¯åº¦è£å‰ªï¼ˆä¹‹å‰æ²¡æœ‰ï¼‰
    
    # âœ… æ¢¯åº¦æ£€æŸ¥ç‚¹ï¼šèŠ‚çœæ˜¾å­˜å¹¶å¹³æ»‘æ¢¯åº¦
    gradient_checkpointing=True,  # ä¹‹å‰æ²¡æœ‰
    
    # âœ… å­¦ä¹ ç‡ï¼šé™ä½åˆ° 1e-4ï¼ˆä¹‹å‰æ˜¯ 5e-4ï¼‰
    learning_rate=1e-4,
    
    # âœ… æ··åˆç²¾åº¦ï¼šä½¿ç”¨ fp16ï¼ˆä¹‹å‰å¯èƒ½æ˜¯ bf16 æˆ–æ²¡æœ‰ï¼‰
    fp16=True,
    
    # âœ… å­¦ä¹ ç‡é¢„çƒ­ï¼š10% çš„æ­¥æ•°ç”¨äºé¢„çƒ­
    warmup_ratio=0.1,
    
    # âœ… NaN/Inf æ£€æµ‹ï¼šè‡ªåŠ¨è¿‡æ»¤å¼‚å¸¸å€¼
    logging_nan_inf_filter=True,
    
    # âœ… æ‰¹æ¬¡è®¾ç½®ï¼šæ›´å°çš„æ‰¹æ¬¡ + æ¢¯åº¦ç´¯ç§¯
    per_device_train_batch_size=2,  # ä¹‹å‰æ˜¯ 1
    gradient_accumulation_steps=8,   # ä¹‹å‰æ˜¯ 16
)
```

**ä½œç”¨**ï¼š
- âœ… `max_grad_norm=0.3`ï¼šç¡¬æ€§é™åˆ¶æ¢¯åº¦èŒƒæ•°ï¼Œé˜²æ­¢çˆ†ç‚¸
- âœ… `gradient_checkpointing=True`ï¼šé€šè¿‡é‡è®¡ç®—å‡å°‘æ˜¾å­˜ï¼ŒåŒæ—¶å¹³æ»‘æ¢¯åº¦
- âœ… `learning_rate=1e-4`ï¼šæ›´ä¿å®ˆçš„å­¦ä¹ ç‡ï¼Œé€‚åˆå¤§æ¨¡å‹
- âœ… `warmup_ratio=0.1`ï¼šé€æ­¥å¢åŠ å­¦ä¹ ç‡ï¼Œé¿å…åˆæœŸæ¢¯åº¦è¿‡å¤§
- âœ… `logging_nan_inf_filter=True`ï¼šè‡ªåŠ¨æ£€æµ‹å¹¶æŠ¥å‘Š NaN/Inf

---

### 5. ä¼˜åŒ–å™¨ - 8bit AdamWï¼ˆç¬¬388-395è¡Œï¼‰

**ä½ç½®**ï¼š`src/train/pcb_train.py` çš„ `train_pcb_model` å‡½æ•°

**å…³é”®ä¿®æ”¹**ï¼š
```python
# âœ… 8bit AdamW ä¼˜åŒ–å™¨ï¼ˆä¸4bitåŠ è½½é…åˆæ›´ç¨³ï¼‰
try:
    from bitsandbytes.optim import AdamW8bit
    optimizer = AdamW8bit(model.parameters(), lr=learning_rate)
    optimizers = (optimizer, None)
except Exception as e:
    print(f"âš ï¸  æœªå®‰è£…bitsandbytesï¼Œå›é€€åˆ°é»˜è®¤AdamW: {e}")
    optimizers = (None, None)
```

**ä½œç”¨**ï¼š
- âœ… `AdamW8bit` æ˜¯ä¸“é—¨ä¸ºé‡åŒ–æ¨¡å‹ä¼˜åŒ–çš„ä¼˜åŒ–å™¨
- âœ… ä¸ 4-bit é‡åŒ–é…åˆä½¿ç”¨æ›´ç¨³å®š
- âœ… å‡å°‘ä¼˜åŒ–å™¨çŠ¶æ€çš„å†…å­˜å ç”¨ï¼Œé™ä½æ•°å€¼ä¸ç¨³å®šé£é™©

---

### 6. æ¨¡å‹è®­ç»ƒæ¨¡å¼ - ç¡®ä¿å¤„äºè®­ç»ƒçŠ¶æ€ï¼ˆç¬¬357è¡Œï¼‰

**ä½ç½®**ï¼š`src/train/pcb_train.py` çš„ `train_pcb_model` å‡½æ•°

**å…³é”®ä¿®æ”¹**ï¼š
```python
# âœ… ç¡®ä¿æ¨¡å‹å¤„äºè®­ç»ƒæ¨¡å¼
model.train()
```

**ä½œç”¨**ï¼š
- âœ… ç¡®ä¿æ‰€æœ‰å±‚éƒ½å¤„äºè®­ç»ƒæ¨¡å¼ï¼ˆå¯ç”¨ dropoutã€batch norm ç­‰ï¼‰
- âœ… ç¡®ä¿æ¢¯åº¦è®¡ç®—æ­£ç¡®

---

## ğŸ“Š å‚æ•°å¯¹æ¯”è¡¨

| å‚æ•° | ä¹‹å‰ï¼ˆæœ‰é—®é¢˜ï¼‰ | ç°åœ¨ï¼ˆå·²ä¿®å¤ï¼‰ | ä½œç”¨ |
|------|---------------|---------------|------|
| **æ¨¡å‹ç±»** | `AutoModelForVision2Seq` | `Qwen3VLForConditionalGeneration` | æ¶æ„åŒ¹é… |
| **æ ‡ç­¾æ©ç ** | æ‰‹åŠ¨åŒ¹é…ï¼ˆé”™è¯¯ï¼‰ | `apply_chat_template` + æ­£ç¡®æ©ç  | åªè®¡ç®— assistant éƒ¨åˆ† |
| **å­¦ä¹ ç‡** | `5e-4` | `1e-4` | æ›´ä¿å®ˆï¼Œé€‚åˆå¤§æ¨¡å‹ |
| **æ¢¯åº¦è£å‰ª** | âŒ æ²¡æœ‰ | âœ… `max_grad_norm=0.3` | ç¡¬æ€§é™åˆ¶æ¢¯åº¦èŒƒæ•° |
| **æ¢¯åº¦æ£€æŸ¥ç‚¹** | âŒ æ²¡æœ‰ | âœ… `gradient_checkpointing=True` | å¹³æ»‘æ¢¯åº¦ï¼ŒèŠ‚çœæ˜¾å­˜ |
| **ä¼˜åŒ–å™¨** | é»˜è®¤ AdamW | `AdamW8bit` | ä¸é‡åŒ–æ¨¡å‹é…åˆæ›´ç¨³ |
| **æ‰¹æ¬¡å¤§å°** | `1` | `2` | æ›´ç¨³å®šçš„æ¢¯åº¦ä¼°è®¡ |
| **æ¢¯åº¦ç´¯ç§¯** | `16` | `8` | å¹³è¡¡ç¨³å®šæ€§å’Œæ•ˆç‡ |
| **å­¦ä¹ ç‡é¢„çƒ­** | âŒ æ²¡æœ‰ | âœ… `warmup_ratio=0.1` | é€æ­¥å¢åŠ å­¦ä¹ ç‡ |
| **NaN/Inf æ£€æµ‹** | âŒ æ²¡æœ‰ | âœ… `logging_nan_inf_filter=True` | è‡ªåŠ¨æ£€æµ‹å¼‚å¸¸ |

---

## ğŸ” å¦‚ä½•ç›‘æ§è®­ç»ƒè¿‡ç¨‹

### 1. ä½¿ç”¨ç›‘æ§è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# åœ¨å¦ä¸€ä¸ªç»ˆç«¯è¿è¡Œ
python tools/monitor_training.py \
    --output_dir ./checkpoints/pcb_checkpoints \
    --interval 5
```

**ç›‘æ§æŒ‡æ ‡**ï¼š
- âœ… Loss è¶‹åŠ¿ï¼ˆåº”è¯¥å¹³æ»‘ä¸‹é™ï¼‰
- âœ… æ¢¯åº¦èŒƒæ•°ï¼ˆåº”è¯¥ < 1.0ï¼Œå¦‚æœ > 10 å¯èƒ½æœ‰é—®é¢˜ï¼‰
- âœ… å­¦ä¹ ç‡å˜åŒ–ï¼ˆåº”è¯¥å…ˆä¸Šå‡åä¸‹é™ï¼‰

### 2. æŸ¥çœ‹ trainer_state.json

è®­ç»ƒè¿‡ç¨‹ä¸­ä¼šè‡ªåŠ¨ç”Ÿæˆ `./checkpoints/pcb_checkpoints/trainer_state.json`ï¼ŒåŒ…å«ï¼š
- `log_history`ï¼šæ¯æ­¥çš„ lossã€learning_rateã€grad_norm
- å¦‚æœçœ‹åˆ° `grad_norm` > 10 æˆ– loss çªç„¶å˜æˆ NaNï¼Œè¯´æ˜å¯èƒ½æœ‰é—®é¢˜

### 3. æ£€æŸ¥æ—¥å¿—è¾“å‡º

è®­ç»ƒæ—¶ä¼šæ¯ 10 æ­¥è¾“å‡ºä¸€æ¬¡æ—¥å¿—ï¼ˆ`logging_steps=10`ï¼‰ï¼Œå…³æ³¨ï¼š
- âœ… Loss æ˜¯å¦å¹³æ»‘ä¸‹é™
- âœ… æ˜¯å¦æœ‰ "NaN" æˆ– "Inf" è­¦å‘Š
- âœ… æ¢¯åº¦èŒƒæ•°æ˜¯å¦æ­£å¸¸ï¼ˆ< 1.0ï¼‰

---

## âš ï¸ å¦‚æœä»ç„¶å‡ºç°æ¢¯åº¦çˆ†ç‚¸

å¦‚æœè®­ç»ƒè¿‡ç¨‹ä¸­ä»ç„¶å‡ºç°æ¢¯åº¦çˆ†ç‚¸ï¼ˆloss å˜æˆ NaN æˆ–çªç„¶å¢å¤§ï¼‰ï¼ŒæŒ‰ä»¥ä¸‹é¡ºåºæ£€æŸ¥ï¼š

1. **æ£€æŸ¥æ•°æ®**ï¼šç¡®ä¿æ•°æ®æ ¼å¼æ­£ç¡®ï¼Œæ²¡æœ‰æŸåçš„å›¾åƒæˆ–æ–‡æœ¬
2. **é™ä½å­¦ä¹ ç‡**ï¼šå°† `--learning_rate` ä» `1e-4` é™åˆ° `5e-5`
3. **åŠ å¼ºæ¢¯åº¦è£å‰ª**ï¼šå°† `max_grad_norm` ä» `0.3` é™åˆ° `0.1`
4. **å‡å°æ‰¹æ¬¡å¤§å°**ï¼šå°† `--batch_size` ä» `2` é™åˆ° `1`
5. **æ£€æŸ¥æ¨¡å‹æ–‡ä»¶**ï¼šç¡®ä¿æ¨¡å‹æ–‡ä»¶å®Œæ•´ï¼ˆæœ‰ `processor_config.json` ç­‰ï¼‰

---

## âœ… æ€»ç»“

æ‰€æœ‰é˜²æ­¢æ¢¯åº¦çˆ†ç‚¸çš„å…³é”®æªæ–½éƒ½å·²åˆ°ä½ï¼š

1. âœ… **æ­£ç¡®çš„æ ‡ç­¾æ©ç **ï¼šåªè®¡ç®— assistant éƒ¨åˆ†çš„ loss
2. âœ… **æ­£ç¡®çš„æ¨¡å‹ç±»**ï¼šä½¿ç”¨ `Qwen3VLForConditionalGeneration`
3. âœ… **æ¢¯åº¦è£å‰ª**ï¼š`max_grad_norm=0.3`
4. âœ… **æ¢¯åº¦æ£€æŸ¥ç‚¹**ï¼š`gradient_checkpointing=True`
5. âœ… **ä¿å®ˆçš„å­¦ä¹ ç‡**ï¼š`1e-4` + `warmup_ratio=0.1`
6. âœ… **8bit ä¼˜åŒ–å™¨**ï¼š`AdamW8bit`
7. âœ… **è§†è§‰å¡”å†»ç»“**ï¼šé˜²æ­¢ç ´åé¢„è®­ç»ƒç‰¹å¾
8. âœ… **NaN/Inf æ£€æµ‹**ï¼š`logging_nan_inf_filter=True`

**å¯ä»¥æ”¾å¿ƒå¼€å§‹è®­ç»ƒï¼** ğŸš€

